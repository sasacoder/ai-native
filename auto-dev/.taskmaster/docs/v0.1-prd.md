# Auto-Dev V0.1 PRD: Plugin 骨架 + 基础执行

## 目标
构建 Auto-Dev Plugin 的基础框架，实现核心执行流程。

## 范围
- Plugin 目录结构和配置
- `/auto-dev` 主命令
- `execute-loop` Skill
- Ralph Loop 集成

## 验收标准
1. `/auto-dev` 命令可被 Claude Code 识别
2. 执行后创建 git worktree 隔离环境
3. 将设计文档复制到 worktree 中
4. 调用 TaskMaster parse_prd 解析 PRD
5. 启动 Ralph Loop 执行任务
6. 简单任务（1-2 个）能完整执行到 `ALL TASKS DONE`

---

## 组件定义

### 1. Plugin 配置

#### 目录结构
```
auto-dev/
├── .claude-plugin/
│   └── plugin.json
├── commands/
│   └── auto-dev.md
└── skills/
    └── execute-loop/
        └── SKILL.md
```

#### plugin.json
```json
{
  "name": "auto-dev",
  "version": "0.1.0",
  "description": "自动化开发助手 - 快速迭代，持续学习",
  "commands": ["auto-dev"],
  "skills": ["execute-loop"],
  "mcp_dependencies": ["taskmaster-ai"]
}
```

---

### 2. /auto-dev 命令 (commands/auto-dev.md)

#### 职责
- 初始化执行环境（git worktree）
- 将设计文档复制到隔离环境
- 检查/解析任务
- 启动 Ralph Loop

#### 流程
1. **环境准备**
   - 检查 TaskMaster 初始化状态
   - 调用 superpowers:using-git-worktrees 创建隔离环境

2. **文档准备**
   - 将用户提供的设计文档复制到 worktree 中
   - 目标路径: `.taskmaster/docs/prd.txt`（或 `.md`）

3. **任务检查**
   - 调用 TaskMaster get_tasks 检查是否有未完成任务
   - 有未完成任务 → 跳过步骤4
   - 无任务 → 执行步骤4

4. **任务拆解**（首次运行或无任务时）
   - 调用 TaskMaster parse_prd 解析设计文档
   - numTasks: 0（自动判断）

5. **启动执行**
   - 启动 Ralph Loop:
     ```
     /ralph-loop "使用 Skill 工具调用 auto-dev:execute-loop" \
       --completion-promise 'ALL TASKS DONE' \
       --max-iterations 50
     ```

#### 测试边界
| 测试点 | 验证内容 |
|-------|---------|
| 环境准备 | worktree 创建成功 |
| 文档复制 | 设计文档成功复制到 worktree |
| 任务检查 | 有未完成任务时跳过 parse_prd |
| 任务拆解 | parse_prd 参数正确 |
| 循环启动 | Ralph Loop 参数正确（promise + max-iterations） |

---

### 3. execute-loop Skill (skills/execute-loop/SKILL.md)

#### 职责
- 获取并执行当前任务
- 执行 TDD 流程
- 处理执行结果
- 输出完成信号

#### 单次迭代流程
1. **获取当前任务**
   - 调用 TaskMaster next_task 获取待执行任务
   - 若无待执行任务 → 输出 `<promise>ALL TASKS DONE</promise>`

2. **TDD 实现**（遵循 superpowers:test-driven-development）
   - 写失败测试
   - 实现代码使测试通过
   - 重构

3. **验证**（遵循 superpowers:verification-before-completion）
   - 运行测试/程序
   - 检查预期输出
   - 必须有验证证据才能声明完成

4. **结果处理**
   - 通过 → TaskMaster set_task_status(done)
   - 失败 → 调用 superpowers:systematic-debugging → 重试
   - 多次失败 → 暂停并提示用户介入

#### 测试边界
| 测试点 | 验证内容 |
|-------|---------|
| 任务获取 | next_task 返回空时输出 promise |
| TDD 执行 | test-driven-development 流程正确 |
| 验证执行 | verification-before-completion 流程正确 |
| 成功处理 | set_task_status(done) 被调用 |
| 失败处理 | systematic-debugging 被调用 |
| Promise 时机 | 仅在所有任务完成后输出 |

---

## 依赖
- superpowers:using-git-worktrees
- superpowers:test-driven-development
- superpowers:verification-before-completion
- superpowers:systematic-debugging
- taskmaster-ai MCP server
- ralph-loop 命令
