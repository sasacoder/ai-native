# Auto-Dev V0.3 PRD

## 目标

实现规则自动应用，完善状态查看和取消功能。

## 依赖

- V0.2 完成

## 范围

- apply-rules Skill
- execute-prompt 模板
- /auto-dev:status 命令
- /auto-dev:cancel 命令
- project-facts.json 自动分析

## 新增目录结构

```
auto-dev/
├── commands/
│   ├── status.md           # 新增
│   └── cancel.md           # 新增
├── skills/
│   └── apply-rules/        # 新增
│       └── SKILL.md
└── templates/              # 新增
    └── execute-prompt.md
```

## 组件定义

### apply-rules Skill

**文件**: `skills/apply-rules/SKILL.md`

**职责**: 匹配当前任务相关的历史规则

**流程**:
1. 读取 .autodev/rules.md
2. 分析当前任务描述
3. 匹配相关规则并排序
4. 返回匹配的规则列表

**测试边界**:
| 测试点 | 验证内容 |
|-------|---------|
| 规则加载 | rules.md 解析正确 |
| 规则匹配 | 相关规则被正确识别 |
| 排序逻辑 | 按相关度排序 |
| 无规则时 | rules.md 不存在时返回空列表 |
| 无匹配时 | 无相关规则时返回空列表 |

### execute-prompt 模板

**文件**: `templates/execute-prompt.md`

**职责**: 构建每次迭代的执行上下文

**变量**:
| 变量 | 来源 | 说明 |
|-----|------|------|
| `{{task_id}}` | TaskMaster next_task | 当前任务 ID |
| `{{task_description}}` | TaskMaster next_task | 任务描述 |
| `{{dependencies}}` | TaskMaster next_task | 依赖的任务列表 |
| `{{project_facts}}` | .autodev/project-facts.json | 项目技术栈等 |
| `{{matched_rules}}` | apply-rules skill | 匹配的经验规则 |

**测试边界**:
| 测试点 | 验证内容 |
|-------|---------|
| 变量替换 | 所有变量被正确替换 |
| 空值处理 | 变量为空时不产生错误 |
| 格式完整 | 输出包含所有必要章节 |

### /auto-dev:status 命令

**文件**: `commands/status.md`

**职责**: 聚合展示执行状态信息

**显示内容**:
- 当前工作分支
- 任务进度: 已完成 / 总数
- 当前任务详情
- Ralph Loop 迭代次数
- 最近的验证结果

**测试边界**:
| 测试点 | 验证内容 |
|-------|---------|
| 分支信息 | 正确读取当前 git 分支 |
| 任务进度 | get_tasks 返回值正确解析 |
| 迭代次数 | .claude/ralph-loop.local.md 读取正确 |
| 无状态时 | 优雅处理文件不存在的情况 |

### /auto-dev:cancel 命令

**文件**: `commands/cancel.md`

**职责**: 停止 Ralph Loop、保留工作成果

**流程**:
1. 删除 .claude/ralph-loop.local.md 状态文件
2. 保留当前分支代码和 TaskMaster 状态
3. 用户确认对话

**测试边界**:
| 测试点 | 验证内容 |
|-------|---------|
| 循环停止 | .claude/ralph-loop.local.md 被删除 |
| 成果保留 | git 分支和文件变更不受影响 |
| 任务状态 | TaskMaster 任务状态保持不变 |
| 用户确认 | 确认对话框正确显示进度 |
| 无循环时 | 优雅处理无活跃循环的情况 |

### project-facts.json

**位置**: `.autodev/project-facts.json`

**生成时机**: 首次运行 /auto-dev 时自动分析

**内容**:
```json
{
  "techStack": ["React", "TypeScript", "Tailwind"],
  "directoryConventions": {
    "components": "src/components/",
    "hooks": "src/hooks/"
  },
  "existingComponents": ["Button", "Modal", "Form"],
  "codeStyle": {
    "naming": "camelCase",
    "indent": 2
  }
}
```

## 验收标准

- [ ] apply-rules 能正确匹配规则
- [ ] execute-prompt 变量替换正确
- [ ] /auto-dev:status 显示完整状态
- [ ] /auto-dev:cancel 能安全取消
- [ ] project-facts.json 自动生成
