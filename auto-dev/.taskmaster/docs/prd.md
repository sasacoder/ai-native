# Auto-Dev V0.2 PRD: Fix 命令 + 经验学习

## 目标
实现用户修正入口和经验学习机制，让系统从修正中学习。

## 范围
- `/auto-dev:fix` 修正命令
- `learn-from-fix` Skill
- 规则存储 (.autodev/rules.md)

## 前置条件
- V0.1 已完成（基础执行流程可用）

## 验收标准
1. `/auto-dev:fix "问题描述"` 命令可用
2. 修正后能提取业务规则
3. 用户确认后规则写入 `.autodev/rules.md`
4. Ralph Loop 运行中可介入修正并继续

---

## 组件定义

### 1. /auto-dev:fix 命令 (commands/fix.md)

#### 职责
- 接收用户反馈的问题
- 执行代码修正
- 触发经验学习
- 恢复执行流程

#### 流程
1. **记录问题**
   - 关联当前任务上下文
   - 记录用户反馈的具体问题

2. **执行修正**
   - 根据问题描述修改代码
   - 运行验证确认修复

3. **提取经验**
   - 调用 learn-from-fix skill
   - 询问用户是否记住该规则

4. **继续执行**
   - 若 Ralph Loop 仍在运行 → 自动继续下一迭代
   - 若 Ralph Loop 已停止 → 询问用户是否重新启动

#### 用法示例
```
/auto-dev:fix "登录后应该跳转首页而不是个人中心"
/auto-dev:fix "价格应该向下取整"
```

#### 测试边界
| 测试点 | 验证内容 |
|-------|---------|
| 问题记录 | 正确关联当前任务上下文 |
| 修正执行 | 代码修改后运行验证 |
| 经验提取 | learn-from-fix skill 被正确调用 |
| 循环运行时 | Ralph Loop 运行中自动继续 |
| 循环停止时 | 询问用户是否重新启动 |

---

### 2. learn-from-fix Skill (skills/learn-from-fix/SKILL.md)

#### 职责
- 分析修正前后的代码差异
- 提取可泛化的业务规则
- 询问用户是否记录
- 写入规则文件

#### 流程
1. **分析偏差**
   - 对比修正前后的代码差异
   - 提取可泛化的业务规则

2. **生成规则描述**
   - 格式: "当遇到 [情况] 时，应该 [做法]"
   - 确保规则足够具体且可复用

3. **用户确认**
   ```
   ✅ 已修复，登录后现在跳转到首页

   💡 要记住这个规则吗？
      "用户登录成功后跳转首页"

   [记住] [这次算了]
   ```

4. **记录规则**（若用户选择记住）
   - 追加到 .autodev/rules.md
   - 格式:
     ```markdown
     ## [日期] 从任务 "XXX" 学到的规则
     - 规则: 当遇到 [情况] 时，应该 [做法]
     - 原因: [用户反馈]
     - 相关文件: [涉及的文件路径]
     ```

#### 测试边界
| 测试点 | 验证内容 |
|-------|---------|
| 差异分析 | 正确识别修正前后的关键差异 |
| 规则提取 | 生成的规则格式正确且可复用 |
| 用户确认 | 对话框正确显示规则描述 |
| 规则写入 | rules.md 追加格式正确 |
| 用户拒绝 | 选择"这次算了"时不写入 |

---

### 3. 规则存储结构

#### .autodev/rules.md 示例
```markdown
# 项目经验规则

## 2024-01-15 从任务 "添加用户登录" 学到的规则
- 规则: 用户登录成功后跳转首页
- 原因: 用户反馈"登录后应该跳转首页而不是个人中心"
- 相关文件: src/auth/login.ts

## 2024-01-16 从任务 "实现商品列表" 学到的规则
- 规则: 价格计算向下取整
- 原因: 用户反馈"价格应该向下取整"
- 相关文件: src/utils/price.ts
```

---

## 更新 plugin.json
```json
{
  "name": "auto-dev",
  "version": "0.2.0",
  "description": "自动化开发助手 - 快速迭代，持续学习",
  "commands": ["auto-dev", "fix"],
  "skills": ["execute-loop", "learn-from-fix"],
  "mcp_dependencies": ["taskmaster-ai"]
}
```

---

## 依赖
- V0.1 所有组件
- .autodev/ 目录（自动创建）
