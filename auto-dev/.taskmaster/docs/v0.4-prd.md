# Auto-Dev V0.4 PRD

## 目标

优化执行效率，添加历史追踪和指标统计。

## 依赖

- V0.3 完成

## 范围

- task-history.json 任务历史
- metrics.json 指标统计
- 性能优化
- 边界情况处理

## 新增存储

```
.autodev/
├── task-history.json   # 任务执行历史
└── metrics.json        # 成功率等指标
```

## 组件定义

### task-history.json

**位置**: `.autodev/task-history.json`

**职责**: 记录任务执行历史，用于分析和回溯

**格式**:
```json
{
  "history": [
    {
      "taskId": "1",
      "title": "实现用户登录",
      "startedAt": "2024-01-15T10:00:00Z",
      "completedAt": "2024-01-15T10:15:00Z",
      "iterations": 3,
      "status": "done",
      "fixes": [
        {
          "description": "登录后跳转首页",
          "timestamp": "2024-01-15T10:10:00Z"
        }
      ]
    }
  ]
}
```

### metrics.json

**位置**: `.autodev/metrics.json`

**职责**: 统计成功率等指标

**格式**:
```json
{
  "totalTasks": 20,
  "completedTasks": 18,
  "failedTasks": 2,
  "successRate": 0.9,
  "averageIterations": 2.5,
  "totalFixes": 5,
  "rulesLearned": 8,
  "lastUpdated": "2024-01-15T12:00:00Z"
}
```

## 优化项

### 上下文长度优化

- 精简 execute-prompt 模板
- 仅注入最相关的规则（top 5）
- project-facts 按需加载

### 规则匹配算法优化

- 从关键词匹配升级为语义匹配
- 考虑使用 embedding 相似度
- 规则去重和合并

### 错误恢复机制

- 迭代失败后的状态恢复
- 中断后的断点续传
- 异常情况的优雅降级

### 大型项目支持

- 任务分批执行
- 增量式 project-facts 更新
- 规则文件分片

## 验收标准

- [ ] 任务历史正确记录
- [ ] 指标统计准确
- [ ] 80% 任务成功率
- [ ] 无明显性能问题
- [ ] 大型项目（50+ 任务）可正常运行
