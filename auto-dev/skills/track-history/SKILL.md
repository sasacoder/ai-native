---
name: track-history
description: 记录任务执行历史到 task-history.json
---

# Track History Skill

记录每个任务的执行详情，用于后续分析和指标计算。

## 职责
- 记录任务开始/完成时间
- 跟踪迭代次数
- 记录应用的规则
- 记录收到的修正

## 输入/输出
- **输入**: 任务执行事件（开始、完成、迭代、修正）
- **输出**: 追加到 `.autodev/task-history.json`

## 数据结构

**task-history.json 格式：**

```json
{
  "executions": [
    {
      "taskId": "1",
      "taskTitle": "实现用户登录",
      "startedAt": "2024-01-15T10:00:00Z",
      "completedAt": "2024-01-15T10:25:00Z",
      "iterations": 3,
      "status": "done",
      "rulesApplied": ["rule-001", "rule-002"],
      "fixesReceived": 1
    }
  ]
}
```

## 流程

### 1. 任务开始

当任务状态变为 `in-progress` 时记录：

```
📝 记录任务开始...
- 任务: #3 实现用户登录功能
- 时间: 2024-01-15T10:00:00Z
```

**记录内容：**
```json
{
  "taskId": "3",
  "taskTitle": "实现用户登录功能",
  "startedAt": "2024-01-15T10:00:00Z",
  "iterations": 0,
  "status": "in-progress",
  "rulesApplied": [],
  "fixesReceived": 0
}
```

### 2. 迭代记录

每次 Ralph Loop 迭代时更新：

```
📝 记录迭代...
- 任务: #3
- 迭代: 2
```

**更新操作：**
- `iterations` += 1

### 3. 规则应用记录

当 apply-rules 返回匹配规则时记录：

```
📝 记录规则应用...
- 任务: #3
- 规则: rule-001, rule-002
```

**更新操作：**
- `rulesApplied` 追加规则 ID

### 4. 修正记录

当用户使用 `/fix` 命令时记录：

```
📝 记录修正...
- 任务: #3
- 修正次数: 1
```

**更新操作：**
- `fixesReceived` += 1

### 5. 任务完成

当任务状态变为 `done` 时记录：

```
📝 记录任务完成...
- 任务: #3
- 完成时间: 2024-01-15T10:25:00Z
- 总迭代: 3
```

**更新操作：**
- `completedAt` = 当前时间
- `status` = "done"

## 查询方法

**按日期范围查询：**
```
获取 2024-01-01 到 2024-01-31 的执行记录
```

**按状态查询：**
```
获取所有 status="done" 的记录
```

**按任务查询：**
```
获取 taskId="3" 的执行记录
```

## 错误处理

| 错误类型 | 处理方式 |
|---------|---------|
| 文件不存在 | 创建初始结构 |
| 写入失败 | 重试 3 次后记录错误 |
| 并发写入 | 使用文件锁或队列 |
| JSON 损坏 | 备份并重建文件 |

## 与 execute-loop 的集成

在 execute-loop 的各个阶段调用：

```
步骤1 (获取任务) → 记录任务开始
步骤2 (应用规则) → 记录规则应用
步骤5 (结果处理) → 记录迭代/完成
```

## 规则有效性跟踪（V0.4）

跟踪每条规则的应用效果，用于优化规则排序。

**规则应用记录扩展：**

```json
{
  "ruleApplications": [
    {
      "ruleId": "rule-001",
      "taskId": "3",
      "appliedAt": "2024-01-15T10:05:00Z",
      "iterationsToCompletion": 2,
      "success": true
    }
  ]
}
```

**有效性指标计算：**

| 指标 | 计算公式 |
|-----|---------|
| 成功率 | 成功次数 / 应用总数 |
| 平均迭代 | 总迭代数 / 成功次数 |
| 有效性分数 | 0.6 * 成功率 + 0.4 * (1/平均迭代) |

**规则排名：**

```
📊 规则有效性排名

1. [0.92] 用户登录成功后跳转首页
   ↳ 成功率: 95%, 平均迭代: 1.2

2. [0.78] 表单验证使用前端实时校验
   ↳ 成功率: 80%, 平均迭代: 2.0

3. [0.65] 列表默认显示10条
   ↳ 成功率: 70%, 平均迭代: 2.5
```

**规则改进建议：**

```
📋 规则改进建议

低效规则 (有效性 < 0.5):
- rule-005: "API 错误处理" (0.42)
  ↳ 建议: 细化错误类型，添加具体示例

未使用规则 (30天未应用):
- rule-003: "分页参数验证"
  ↳ 建议: 检查是否仍然适用
```

**趋势分析：**

```
📈 规则使用趋势 (最近7天)

应用次数:
- rule-001: ████████ 8次
- rule-002: █████ 5次
- rule-004: ███ 3次

有效性变化:
- rule-001: ↑ 0.85 → 0.92 (+8%)
- rule-002: → 0.78 (稳定)
- rule-003: ↓ 0.70 → 0.65 (-7%)
```

