---
name: apply-rules
description: 加载并应用项目经验规则到当前任务
---

# Apply Rules Skill

从 `.autodev/rules.md` 加载项目经验规则，并匹配到当前任务。

## 职责
- 读取并解析 `.autodev/rules.md`
- 将规则与当前任务描述匹配
- 返回相关规则供执行上下文使用

## 输入/输出
- **输入**: 当前任务描述
- **输出**: 匹配的规则列表

## 流程

### 1. 加载规则

**读取规则文件：**

从 `.autodev/rules.md` 读取所有已学习的规则：

```
📂 加载规则...
- 文件: .autodev/rules.md
- 规则数: 5
```

**处理缺失文件：**

若文件不存在，返回空列表并继续：

```
📂 加载规则...
- 文件不存在，跳过规则应用
```

### 2. 解析规则

**规则格式：**

每条规则包含以下信息：
- 日期
- 来源任务
- 规则内容
- 原因
- 相关文件

**解析示例：**

```markdown
## 2024-01-15 从任务 "添加用户登录" 学到的规则
- 规则: 用户登录成功后跳转首页
- 原因: 用户反馈"登录后应该跳转首页而不是个人中心"
- 相关文件: src/auth/login.ts
```

解析为：
```json
{
  "date": "2024-01-15",
  "sourceTask": "添加用户登录",
  "rule": "用户登录成功后跳转首页",
  "reason": "登录后应该跳转首页而不是个人中心",
  "files": ["src/auth/login.ts"]
}
```

### 3. 匹配规则（V0.4 增强）

**任务类型分类：**

首先识别当前任务的类型：

| 任务类型 | 关键词模式 |
|---------|----------|
| login | 登录, 认证, auth, login |
| payment | 支付, payment, checkout, 订单 |
| list | 列表, list, table, 分页 |
| form | 表单, form, input, 验证 |
| crud | 增删改查, create, update, delete |

```
🏷️ 任务类型识别...
任务: 实现用户注册功能
类型: form (置信度: 0.85)
```

**语义相似度计算：**

使用多维度评分：

| 匹配维度 | 权重 | 说明 |
|---------|------|------|
| 任务类型 | 40% | 登录→登录规则，支付→支付规则 |
| 关键词 | 30% | 任务描述中的关键词匹配 |
| 文件路径 | 20% | 涉及相同文件的规则优先 |
| 时间衰减 | 10% | 近期规则权重略高 |

**时间衰减算法：**

```
衰减因子 = e^(-λ * 天数)
λ = 0.01 (衰减系数)
```

- 今天的规则: 1.0
- 7天前的规则: 0.93
- 30天前的规则: 0.74

**综合评分：**

```
总分 = 0.4 * 类型匹配 + 0.3 * 关键词分 + 0.2 * 路径分 + 0.1 * 时间因子
```

**匹配示例：**

```
🔍 匹配规则...

任务: 实现用户注册功能
类型: form

评分结果:
  1. [0.85] 用户登录成功后跳转首页
     ↳ 类型: 0.9 (form/auth 相关)
     ↳ 关键词: 0.8 ("用户")
     ↳ 路径: 0.7 (src/auth/)
     ↳ 时间: 0.95 (3天前)

  2. [0.62] 表单验证使用前端实时校验
     ↳ 类型: 1.0 (form 精确匹配)
     ↳ 关键词: 0.3 ("功能")
     ↳ 路径: 0.2 (不同目录)
     ↳ 时间: 0.74 (30天前)
```

**性能优化：**

- 规则数 < 100: 全量匹配
- 规则数 >= 100: 先按类型过滤，再计算相似度
- 缓存近期匹配结果，避免重复计算

### 4. 返回结果

**格式化输出：**

返回匹配的规则供 execute-prompt 模板使用：

```
📋 适用规则:
- 用户登录成功后跳转首页（来源: 添加用户登录）
- 表单验证使用前端实时校验（来源: 实现表单组件）
```

若无匹配规则：

```
📋 适用规则: 无
```

## 错误处理

| 错误类型 | 处理方式 |
|---------|---------|
| 文件不存在 | 返回空列表，继续执行 |
| 解析错误 | 记录错误，跳过损坏的规则 |
| 读取失败 | 记录错误，返回空列表 |

