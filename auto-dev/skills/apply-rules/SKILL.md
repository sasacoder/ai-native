---
name: apply-rules
description: 加载并应用项目经验规则到当前任务
---

# Apply Rules Skill

从 `.autodev/rules.md` 加载项目经验规则，并匹配到当前任务。

## 职责
- 读取并解析 `.autodev/rules.md`
- 将规则与当前任务描述匹配
- 返回相关规则供执行上下文使用

## 输入/输出
- **输入**: 当前任务描述
- **输出**: 匹配的规则列表

## 流程

### 1. 加载规则

**读取规则文件：**

从 `.autodev/rules.md` 读取所有已学习的规则：

```
📂 加载规则...
- 文件: .autodev/rules.md
- 规则数: 5
```

**处理缺失文件：**

若文件不存在，返回空列表并继续：

```
📂 加载规则...
- 文件不存在，跳过规则应用
```

### 2. 解析规则

**规则格式：**

每条规则包含以下信息：
- 日期
- 来源任务
- 规则内容
- 原因
- 相关文件

**解析示例：**

```markdown
## 2024-01-15 从任务 "添加用户登录" 学到的规则
- 规则: 用户登录成功后跳转首页
- 原因: 用户反馈"登录后应该跳转首页而不是个人中心"
- 相关文件: src/auth/login.ts
```

解析为：
```json
{
  "date": "2024-01-15",
  "sourceTask": "添加用户登录",
  "rule": "用户登录成功后跳转首页",
  "reason": "登录后应该跳转首页而不是个人中心",
  "files": ["src/auth/login.ts"]
}
```

### 3. 匹配规则

**匹配算法：**

基于任务描述和规则内容进行匹配：
1. 关键词匹配（任务描述中的关键词）
2. 文件路径匹配（涉及相同目录/文件）
3. 相似度评分

**评分规则：**

| 匹配类型 | 权重 |
|---------|------|
| 关键词精确匹配 | 0.5 |
| 关键词部分匹配 | 0.3 |
| 文件路径匹配 | 0.2 |

**匹配示例：**

```
🔍 匹配规则...

任务: 实现用户注册功能
匹配结果:
  1. [0.8] 用户登录成功后跳转首页
     ↳ 关键词匹配: "用户"
  2. [0.5] 表单验证使用前端实时校验
     ↳ 关键词匹配: "功能"
```

### 4. 返回结果

**格式化输出：**

返回匹配的规则供 execute-prompt 模板使用：

```
📋 适用规则:
- 用户登录成功后跳转首页（来源: 添加用户登录）
- 表单验证使用前端实时校验（来源: 实现表单组件）
```

若无匹配规则：

```
📋 适用规则: 无
```

## 错误处理

| 错误类型 | 处理方式 |
|---------|---------|
| 文件不存在 | 返回空列表，继续执行 |
| 解析错误 | 记录错误，跳过损坏的规则 |
| 读取失败 | 记录错误，返回空列表 |

