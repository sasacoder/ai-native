# Auto-Dev V0.4 测试套件

## 概述

本文档定义 V0.4 功能的测试场景和验收标准。

## 1. 项目分析测试

### 1.1 技术栈检测

| 测试场景 | 输入 | 预期输出 |
|---------|------|---------|
| React + TypeScript 项目 | package.json 包含 react, typescript | language: TypeScript, framework: React |
| Vue 项目 | package.json 包含 vue | framework: Vue |
| 纯 JavaScript 项目 | 无 typescript 依赖 | language: JavaScript |
| 无 package.json | 文件不存在 | 使用默认值，继续分析 |

### 1.2 目录结构检测

| 测试场景 | 输入 | 预期输出 |
|---------|------|---------|
| 标准 src 结构 | src/components/, src/hooks/ | 正确识别各目录 |
| 根目录结构 | components/, hooks/ | 正确识别各目录 |
| Monorepo | packages/, apps/ | 检测为 monorepo |
| 空目录 | 目录存在但无文件 | 跳过该目录 |

### 1.3 代码风格检测

| 测试场景 | 输入 | 预期输出 |
|---------|------|---------|
| 统一风格 | 90% 使用 camelCase | 高置信度检测 |
| 混合风格 | 55% 单引号, 45% 双引号 | 低置信度，选择多数 |
| ESLint 配置存在 | .eslintrc 存在 | 参考 ESLint 配置 |

## 2. 规则匹配测试

### 2.1 任务类型分类

| 测试场景 | 任务描述 | 预期类型 |
|---------|---------|---------|
| 登录任务 | "实现用户登录功能" | login |
| 支付任务 | "添加支付流程" | payment |
| 列表任务 | "创建商品列表页" | list |
| 表单任务 | "实现注册表单" | form |

### 2.2 语义相似度

| 测试场景 | 任务 + 规则 | 预期分数 |
|---------|-----------|---------|
| 高相似度 | "用户登录" + "登录成功跳转" | > 0.8 |
| 中相似度 | "用户注册" + "登录成功跳转" | 0.5-0.8 |
| 低相似度 | "商品列表" + "登录成功跳转" | < 0.5 |

### 2.3 时间衰减

| 测试场景 | 规则年龄 | 预期衰减因子 |
|---------|---------|------------|
| 今天创建 | 0 天 | ~1.0 |
| 一周前 | 7 天 | ~0.93 |
| 一月前 | 30 天 | ~0.74 |

## 3. 历史记录测试

### 3.1 任务记录

| 测试场景 | 操作 | 预期结果 |
|---------|------|---------|
| 任务开始 | set_task_status(in-progress) | 记录 startedAt |
| 任务完成 | set_task_status(done) | 记录 completedAt |
| 迭代计数 | 多次循环 | iterations 递增 |
| 规则应用 | apply-rules 返回规则 | rulesApplied 更新 |

### 3.2 数据持久化

| 测试场景 | 操作 | 预期结果 |
|---------|------|---------|
| 正常写入 | 追加记录 | JSON 有效 |
| 并发写入 | 多任务同时写入 | 无数据丢失 |
| 文件损坏 | JSON 格式错误 | 备份并重建 |

## 4. 指标计算测试

### 4.1 成功率

| 测试场景 | 数据 | 预期结果 |
|---------|------|---------|
| 全部一次通过 | 10 任务, 10 个 iterations=1 | 1.0 |
| 50% 一次通过 | 10 任务, 5 个 iterations=1 | 0.5 |
| 无完成任务 | 0 完成任务 | 0 |

### 4.2 平均迭代

| 测试场景 | 数据 | 预期结果 |
|---------|------|---------|
| 均为 1 次 | [1,1,1,1,1] | 1.0 |
| 混合迭代 | [1,2,3,2,2] | 2.0 |
| 空数据 | [] | 0 |

## 5. 完成流程测试

### 5.1 完成检测

| 测试场景 | 条件 | 预期结果 |
|---------|------|---------|
| 全部完成 | 所有任务 done | 输出 ALL TASKS DONE |
| 有待处理 | 存在 pending 任务 | 继续执行 |
| 有进行中 | 存在 in-progress 任务 | 继续执行 |

### 5.2 用户选项

| 测试场景 | 选择 | 预期结果 |
|---------|------|---------|
| 合并到主分支 | 选项 1 | 执行 merge, 清理 worktree |
| 创建 PR | 选项 2 | 推送分支, 创建 PR |
| 稍后处理 | 选项 3 | 保留分支, 退出 |

## 6. 性能测试

| 测试场景 | 条件 | 性能要求 |
|---------|------|---------|
| 规则匹配 | 1000 条规则 | < 100ms |
| 指标计算 | 1000 条历史 | < 50ms |
| 项目分析 | 500 个文件 | < 5s |
| status 命令 | 正常数据 | < 200ms |

## 7. 集成测试

### 7.1 完整工作流

```
1. /auto-dev design.md
2. 创建 worktree ✓
3. 项目分析 ✓
4. 解析 PRD ✓
5. 启动 Ralph Loop ✓
6. 执行任务 (循环)
7. 完成检测 ✓
8. finishing-a-development-branch ✓
```

### 7.2 错误恢复

| 测试场景 | 错误 | 预期恢复 |
|---------|------|---------|
| 任务失败 | 验证不通过 | 调试后重试 |
| 连续失败 | 3 次失败 | 暂停，提示用户 |
| 迁移失败 | 写入错误 | 回滚到备份 |

## 验收标准

- [ ] 所有单元测试通过
- [ ] 集成测试覆盖主要流程
- [ ] 性能测试满足要求
- [ ] 错误场景正确处理
- [ ] 文档与实现一致
